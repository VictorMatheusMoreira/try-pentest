import express from 'express'
import bodyParser from 'body-parser'
import { DatabasePostgres } from './database-postgres.js'
import { sql } from './db.js'

let app = express()
app.use(bodyParser.json())

const database = new DatabasePostgres()

app.post('/user', async (req, res) => {
    const {name, email, password} = req.body

    await database.create({
        name,
        email,
        password
    })

    return res.status(201).send()
})

app.get('/user', async (req, res) => {
    const users = await database.list()
    return res.status(200).json(users)
})

app.put('/user/:id', async (req, res) => {
    const {name, email, password} = req.body
    const id = req.params.id

    await database.update(id, {
        name,
        email,
        password
    }) 
    return res.status(204).send()

})

app.delete('/user/:id', async (req, res) => {
    const id = req.params.id

    await database.delete(id)
    return res.status(204).send()

})

// Essa rota esta usando PREPARED STATEMENT   
app.get('/user/:email/:password', async (req, res) => {
    const { email, password } = req.params

    const query = 'SELECT * FROM users WHERE email = $1 AND password = $2';
    
    try {
        const user = await sql.query(query, [email, password])

        if (user.rows.length === 0) {
            return res.status(404).json({ error: "User not found" })
        }

        return res.status(200).json(user.rows[0])
    } catch (error) {
        return res.status(500).json({ error: "Database error", details: error.message })
    }
})


app.listen(3000, () => {
    console.log('server is running in 3000')
})